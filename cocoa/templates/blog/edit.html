{% extends 'layout/single_column.html' %}

{% block css %}
{{ super() }}
<link rel="stylesheet" href="/static/css/blog/blog.css">
{% endblock %}

{% block content %}

<div class="page-header">
    <h1><small>编辑文章</small></h1>
</div>

<div id="post-new-form">
    {% from 'macros/form.html' import render_field, render_submit %}
    <form method="post" action="{{ url_for('blog.edit', user_id=post.author.id, slug=post.slug) }}">
        {{ form.csrf_token }}
        {{ render_field(form.title, class='span5') }}
        {{ render_field(form.type) }}

        <hr>

        <div class="control-group">
            <div id="ref-books"><ul class="unstyled"></ul></div>
            <a href="#add-ref-books-modal" class="btn" rol="button" data-toggle="modal">+ 添加引用图书</a>
        </div>
        {{ render_field(form.ref_books) }}

        <div id="content-textarea">
            {{ render_field(form.content, class='span7') }}
        </div>

        <select id="mode-switch" class="span2">
            <option value="windows">默认</option>
            <option value="vim">Vim</option>
            <option value="emacs">Emacs</option>
        </select>

        <a class="markdown-help" href="{{ url_for('docs.home', docname='markdown') }}" target="_blank">支持markdown格式&rarr;</a>
        <div id="editor"></div>

        {{ render_field(form.keywords, class='span5', placeholder='请使用英文逗号“,”作分隔符') }}

        <div id="form-submit-btn">
            <button type="submit" class="btn btn-primary">发表</button>
        </div>
    </form>

    <div id="add-ref-books-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-header">
            <h1><small>添加引用</small></h1>
        </div>

        <div class="modal-body">
            {% from 'macros/widget_add_books.html' import widget_add_books %}
            {{ widget_add_books(submit=False) }}
        </div>

        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
            <button class="btn btn-primary">确定</button>
        </div>
    </div><!-- end .modal -->
</div>

<script type="text/javascript" src="/static/js/blog/ref_book_input.js"></script>
<script type="text/javascript" src="/static/js/jquery/jquery.placeholder.min.js"></script>
<script type="text/javascript" src="/static/js/ace/lib/ace.js"></script>
<script type="text/javascript">
$(function() {
    $('input').placeholder();

    var editor = ace.edit('editor');
    var textarea = $('textarea');

    editor.getSession().setMode('ace/mode/markdown');
    editor.getSession().setValue(textarea.val());
    //editor.setTheme('ace/theme/github');

    $('#mode-switch').change(function() {
        editor.setKeyboardHandler('ace/keyboard/' + $(this).val());
    });

    $('#form-submit-btn').click(function() {
        textarea.val(editor.getSession().getValue());
    });
});
</script>

{% endblock %}
